
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    match /users/{userId} {
      // Any authenticated user can read any user profile for the leaderboard.
      allow read: if request.auth != null;
      // A user can only write to their own profile.
      allow write: if request.auth != null && request.auth.uid == userId &&
                      (!request.resource.data.keys().has('displayName') ||
                       (request.resource.data.displayName is string && request.resource.data.displayName.size() < 30));
    }

    // Any authenticated user can read and write to global stats.
    // The game logic handles the updates safely within a transaction.
    match /globalStats/{statId} {
      allow read, write: if request.auth != null;
    }

    // Users can create a new session document for themselves.
    match /sessions/{sessionId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      // Reads, updates, and deletes are disallowed for now.
      allow read, update, delete: if false;
    }
  }
}
